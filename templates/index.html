<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Claude Control</title>
    <!-- Modular CSS -->
    <link rel="stylesheet" href="/static/styles/base.css?v=2">
    <link rel="stylesheet" href="/static/styles/layout.css?v=2">
    <link rel="stylesheet" href="/static/styles/components.css">
    <link rel="stylesheet" href="/static/styles/command.css">
    <link rel="stylesheet" href="/static/styles/logs.css?v=3">
    <link rel="stylesheet" href="/static/styles/batch.css">
    <link rel="stylesheet" href="/static/styles/dashboard.css">
    <link rel="stylesheet" href="/static/styles/settings.css">
    <link rel="stylesheet" href="/static/styles/storage.css?v=3">
    <link rel="stylesheet" href="/static/styles/graph.css">
    <link rel="stylesheet" href="/static/styles/info.css">
    <link rel="stylesheet" href="/static/styles/responsive.css">
    <!-- Playground CSS -->
    <link rel="stylesheet" href="/static/playground/playground.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Three.js (for 3D rendering) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/RGBELoader.js"></script>
    <script>
        // SkeletonUtils polyfill for r128
        THREE.SkeletonUtils = {
            clone: function(source) {
                const sourceLookup = new Map();
                const cloneLookup = new Map();
                const clone = source.clone();

                parallelTraverse(source, clone, function(sourceNode, clonedNode) {
                    sourceLookup.set(clonedNode, sourceNode);
                    cloneLookup.set(sourceNode, clonedNode);
                });

                clone.traverse(function(node) {
                    if (!node.isSkinnedMesh) return;
                    const clonedMesh = node;
                    const sourceMesh = sourceLookup.get(node);
                    const sourceBones = sourceMesh.skeleton.bones;

                    clonedMesh.skeleton = sourceMesh.skeleton.clone();
                    clonedMesh.bindMatrix.copy(sourceMesh.bindMatrix);

                    clonedMesh.skeleton.bones = sourceBones.map(function(bone) {
                        return cloneLookup.get(bone);
                    });

                    clonedMesh.bind(clonedMesh.skeleton, clonedMesh.bindMatrix);
                });

                return clone;

                function parallelTraverse(a, b, callback) {
                    callback(a, b);
                    for (let i = 0; i < a.children.length; i++) {
                        parallelTraverse(a.children[i], b.children[i], callback);
                    }
                }
            }
        };
        console.log('[Three.js] SkeletonUtils polyfill loaded');
    </script>

    <!-- Server-side rendered initial state -->
    <script id="initial-sessions" type="application/json">{{ initial_sessions | tojson | safe }}</script>
    <script id="initial-prompts" type="application/json">{{ initial_prompts | tojson | safe }}</script>
    <script id="initial-health" type="application/json">{{ initial_health | tojson | safe }}</script>
    <script id="initial-stats" type="application/json">{{ initial_stats | tojson | safe }}</script>
    <script>
        // Pre-rendered data from server (SSR)
        window.__INITIAL_STATE__ = {
            sessions: JSON.parse(document.getElementById('initial-sessions').textContent),
            prompts: JSON.parse(document.getElementById('initial-prompts').textContent),
            health: JSON.parse(document.getElementById('initial-health').textContent),
            stats: JSON.parse(document.getElementById('initial-stats').textContent)
        };
        console.log('[SSR] Initial state loaded:', window.__INITIAL_STATE__);
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="logo">Claude Control</h1>
            </div>
            <div class="header-right">
                <div class="health-indicator {{ 'healthy' if initial_health.status == 'healthy' else 'error' }}" id="health-indicator">
                    <span class="health-dot"></span>
                    <span class="health-text">{{ initial_health.status | capitalize if initial_health.status else 'Connecting...' }}</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar - Session List -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2>Sessions</h2>
                    <div class="sidebar-header-actions">
                        <button class="btn btn-primary btn-sm" onclick="showCreateSessionModal()">New Session</button>
                        <button class="btn btn-sm sidebar-toggle-btn" onclick="toggleSidebar()" aria-label="Toggle sidebar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="18 15 12 9 6 15"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="session-stats" id="session-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="stat-total">{{ initial_stats.total }}</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item running">
                        <span class="stat-value" id="stat-running">{{ initial_stats.running }}</span>
                        <span class="stat-label">Running</span>
                    </div>
                    <div class="stat-item error">
                        <span class="stat-value" id="stat-error">{{ initial_stats.error }}</span>
                        <span class="stat-label">Error</span>
                    </div>
                </div>
                <div class="session-list" id="session-list">
                    {% if initial_sessions %}
                        {% for session in initial_sessions %}
                        <div class="session-item" onclick="selectSession('{{ session.session_id }}')">
                            <span class="session-status-dot {{ session.status }}"></span>
                            <div class="session-info">
                                <div class="session-name">
                                    <span class="role-badge {{ 'role-manager' if session.role == 'manager' else 'role-worker' }}">
                                        {{ 'M' if session.role == 'manager' else 'W' }}
                                    </span>
                                    {{ session.session_name or 'Unnamed' }}
                                </div>
                                <div class="session-id">{{ session.session_id[:8] }}...</div>
                            </div>
                            <div class="session-actions">
                                <button class="btn btn-icon btn-sm" onclick="event.stopPropagation(); showDeleteConfirmation('{{ session.session_id }}', '{{ session.session_name or session.session_id }}')" title="Delete">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <p>No sessions yet</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Deleted Sessions -->
                <div class="sidebar-deleted-section" id="deleted-sessions-section">
                    <div class="sidebar-deleted-header" onclick="toggleDeletedSessions()">
                        <span class="sidebar-deleted-toggle" id="deleted-toggle-icon">‚ñ∂</span>
                        <span>Deleted Sessions</span>
                        <span class="sidebar-deleted-badge" id="deleted-count-badge">0</span>
                    </div>
                    <div class="sidebar-deleted-list hidden" id="deleted-sessions-list">
                        <div class="empty-state-small">
                            <p>No deleted sessions</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Panel -->
            <section class="main-panel">
                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn" data-tab="playground" onclick="switchTab('playground')">Playground</button>
                    <button class="tab-btn active" data-tab="command" onclick="switchTab('command')">Command</button>
                    <button class="tab-btn hidden" data-tab="dashboard" id="dashboard-tab-btn" onclick="switchTab('dashboard')">Dashboard</button>
                    <button class="tab-btn" data-tab="logs" onclick="switchTab('logs')">Logs</button>
                    <button class="tab-btn" data-tab="storage" onclick="switchTab('storage')">Storage</button>
                    <button class="tab-btn" data-tab="batch" onclick="switchTab('batch')">Batch</button>
                    <button class="tab-btn" data-tab="graph" onclick="switchTab('graph')">Graph</button>
                    <button class="tab-btn" data-tab="info" onclick="switchTab('info')">Info</button>
                    <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">Settings</button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Playground Tab -->
                    <div class="tab-pane" id="playground-tab">
                        <div class="playground-panel" id="playground-panel">
                            <div class="playground-toolbar">
                                <div class="playground-toolbar-left">
                                    <div class="playground-title">
                                        <span class="playground-title-icon">üèôÔ∏è</span>
                                        City Playground
                                    </div>
                                    <span class="playground-session-count" id="playground-session-count">{{ initial_stats.total }} citizens</span>
                                </div>
                                <div class="playground-toolbar-right">
                                    <button class="playground-btn" onclick="playgroundZoomIn()" title="Zoom In">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    </button>
                                    <button class="playground-btn" onclick="playgroundZoomOut()" title="Zoom Out">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    </button>
                                    <button class="playground-btn" onclick="playgroundResetView()" title="Reset View">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="playground-canvas-container" id="playground-canvas">
                                <div class="playground-loading" id="playground-loading">
                                    <div class="playground-loading-spinner"></div>
                                    <div class="playground-loading-text">Building city...</div>
                                </div>
                            </div>
                            <div class="playground-status-overlay" id="playground-status-overlay"></div>
                            <div class="playground-empty-state" id="playground-empty-state" style="display:none">
                                <div class="playground-empty-text">Create sessions to see citizens in the city!</div>
                            </div>
                        </div>
                    </div>

                    <!-- Command Tab -->
                    <div class="tab-pane active" id="command-tab">
                        <div class="no-session-selected" id="no-session-message">
                            <div class="empty-state">
                                <h3>Select a Session</h3>
                                <p>Choose a session from the list to execute commands</p>
                            </div>
                        </div>
                        <div class="command-panel hidden" id="command-panel">
                            <div class="selected-session-info" id="selected-session-info">
                                <!-- Session info will be displayed here -->
                            </div>
                            <div class="command-input-area">
                                <textarea
                                    id="command-input"
                                    placeholder="Enter your prompt here..."
                                    rows="4"
                                ></textarea>
                                <div class="command-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="skip-permissions" checked>
                                        Skip Permissions
                                    </label>
                                    <span class="session-mode-badge" id="session-mode-badge">Autonomous</span>
                                    <label class="input-label">
                                        Timeout (s):
                                        <input type="number" id="command-timeout" value="1800" min="1" max="7200" readonly title="Set when creating session">
                                    </label>
                                    <label class="input-label">
                                        Max Turns:
                                        <input type="number" id="command-max-turns" value="100" min="1" max="500" readonly title="Set when creating session">
                                    </label>
                                    <label class="input-label">
                                        Max Iterations:
                                        <input type="number" id="autonomous-max-iterations" value="100" min="1" max="500" readonly title="Set when creating session">
                                    </label>
                                </div>
                                <div class="command-actions">
                                    <button class="btn btn-primary" id="execute-btn" onclick="executeCommand()">Execute</button>
                                    <button class="btn btn-danger hidden" id="stop-btn" onclick="stopExecution()">Stop</button>
                                    <button class="btn btn-secondary" onclick="clearOutput()">Clear</button>
                                </div>
                            </div>
                            <div class="command-output-area">
                                <div class="output-header">
                                    <h3>Output</h3>
                                    <span class="execution-status" id="execution-status"></span>
                                </div>
                                <pre class="output-content" id="command-output">No output yet</pre>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard Tab (Manager only) -->
                    <div class="tab-pane" id="dashboard-tab">
                        <div class="dashboard-panel">
                            <div class="dashboard-header">
                                <h3>Manager Dashboard</h3>
                                <div class="dashboard-header-actions">
                                    <span class="dashboard-session-name" id="dashboard-session-name"></span>
                                    <button class="btn btn-sm" onclick="refreshManagerDashboard()">Refresh</button>
                                </div>
                            </div>
                            <div class="dashboard-content">
                                <div class="dashboard-section workers-section">
                                    <div class="section-header">
                                        <h4>Workers</h4>
                                        <span class="worker-count" id="worker-count">0</span>
                                    </div>
                                    <div class="workers-list" id="workers-list">
                                        <div class="empty-state-small">No workers assigned to this manager</div>
                                    </div>
                                </div>
                                <div class="dashboard-section activity-section">
                                    <div class="section-header">
                                        <h4>Activity Timeline</h4>
                                    </div>
                                    <div class="activity-timeline" id="activity-timeline">
                                        <div class="empty-state-small">No activity yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logs Tab -->
                    <div class="tab-pane" id="logs-tab">
                        <div class="no-session-selected" id="no-session-logs-message">
                            <div class="empty-state">
                                <h3>Select a Session</h3>
                                <p>Choose a session from the list to view logs</p>
                            </div>
                        </div>
                        <div class="logs-panel hidden" id="logs-panel">
                            <div class="logs-header">
                                <h3 id="logs-session-title">Session Logs</h3>
                                <div class="logs-controls">
                                    <select id="log-level-filter" onchange="loadSessionLogs()">
                                        <option value="">All Levels</option>
                                        <option value="DEBUG">DEBUG</option>
                                        <option value="INFO">INFO</option>
                                        <option value="WARNING">WARNING</option>
                                        <option value="ERROR">ERROR</option>
                                        <option value="COMMAND">COMMAND</option>
                                        <option value="RESPONSE">RESPONSE</option>
                                        <option value="ITER">ITERATION</option>
                                        <option value="TOOL">TOOL</option>
                                        <option value="STREAM">STREAM</option>
                                    </select>
                                    <label class="auto-refresh-toggle">
                                        <input type="checkbox" id="logs-auto-refresh" checked onchange="toggleLogsAutoRefresh()">
                                        <span class="toggle-switch"></span>
                                        <span>Auto</span>
                                    </label>
                                    <button class="btn btn-sm btn-icon" onclick="loadSessionLogs()" title="Refresh">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M23 4v6h-6M1 20v-6h6"/>
                                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="logs-content" id="logs-content">
                                <div class="loading">Loading logs...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Tab -->
                    <div class="tab-pane" id="batch-tab">
                        <div class="batch-panel">
                            <div class="batch-header">
                                <h3>Batch Command Execution</h3>
                            </div>
                            <div class="batch-sessions">
                                <label>Select Sessions:</label>
                                <div class="batch-session-list" id="batch-session-list">
                                    {% for session in initial_sessions %}
                                    <label class="batch-session-item">
                                        <input type="checkbox" value="{{ session.session_id }}" class="batch-session-checkbox">
                                        <span class="role-badge {{ 'role-manager' if session.role == 'manager' else 'role-worker' }}">
                                            {{ 'M' if session.role == 'manager' else 'W' }}
                                        </span>
                                        {{ session.session_name or session.session_id[:8] }}
                                    </label>
                                    {% else %}
                                    <p class="text-muted">No sessions available</p>
                                    {% endfor %}
                                </div>
                                <div class="batch-select-actions">
                                    <button class="btn btn-sm" onclick="selectAllSessions()">Select All</button>
                                    <button class="btn btn-sm" onclick="deselectAllSessions()">Deselect All</button>
                                </div>
                            </div>
                            <div class="batch-input">
                                <textarea
                                    id="batch-command-input"
                                    placeholder="Enter command to execute on all selected sessions..."
                                    rows="4"
                                ></textarea>
                                <div class="batch-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="batch-parallel" checked>
                                        Execute in Parallel
                                    </label>
                                    <label class="input-label">
                                        Timeout (s):
                                        <input type="number" id="batch-timeout" value="1800" min="1" max="7200">
                                    </label>
                                </div>
                                <button class="btn btn-primary" onclick="executeBatchCommand()">Execute Batch</button>
                            </div>
                            <div class="batch-results" id="batch-results">
                                <!-- Batch results will be displayed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Storage Tab -->
                    <div class="tab-pane" id="storage-tab">
                        <div class="storage-panel">
                            <div class="storage-header">
                                <h3>Session Storage</h3>
                                <div class="storage-actions">
                                    <button class="btn btn-sm" onclick="refreshStorage()">Refresh</button>
                                </div>
                            </div>
                            <div class="storage-content">
                                <div class="storage-tree" id="storage-tree">
                                    <p class="storage-placeholder">Select a session to view its storage</p>
                                </div>
                                <div class="storage-preview" id="storage-preview">
                                    <div class="preview-header">
                                        <span id="preview-filename">No file selected</span>
                                    </div>
                                    <pre class="preview-content" id="preview-content"></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graph Tab -->
                    <div class="tab-pane" id="graph-tab">
                        <div class="graph-panel">
                            <div class="graph-toolbar">
                                <div class="graph-toolbar-left">
                                    <div class="graph-toolbar-title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="12" cy="19" r="2"/><line x1="7" y1="11" x2="10" y2="7"/><line x1="14" y1="7" x2="17" y2="11"/><line x1="12" y1="7" x2="12" y2="17"/></svg>
                                        LangGraph Visualizer
                                    </div>
                                    <span id="graph-session-name"></span>
                                    <span class="graph-type-badge" id="graph-type-badge"></span>
                                </div>
                                <div class="graph-toolbar-right">
                                    <button class="graph-toolbar-btn" onclick="zoomGraphIn()" title="Zoom In">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    </button>
                                    <button class="graph-toolbar-btn" onclick="zoomGraphOut()" title="Zoom Out">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    </button>
                                    <button class="graph-toolbar-btn" onclick="resetGraphView()" title="Reset View">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                                    </button>
                                    <button class="graph-toolbar-btn" onclick="refreshGraphTab()" title="Refresh">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="graph-content-area">
                                <div id="graph-canvas">
                                    <div class="graph-no-session">
                                        <h3>Select a Session</h3>
                                        <p>Choose a session from the sidebar to visualize its graph</p>
                                    </div>
                                </div>
                                <div class="graph-detail-panel" id="graph-detail-panel"></div>
                            </div>
                            <div class="graph-legend">
                                <div class="graph-legend-item">
                                    <span class="graph-legend-dot graph-legend-dot--start"></span> Start
                                </div>
                                <div class="graph-legend-item">
                                    <span class="graph-legend-dot graph-legend-dot--end"></span> End
                                </div>
                                <div class="graph-legend-item">
                                    <span class="graph-legend-line graph-legend-line--normal"></span> Edge
                                </div>
                                <div class="graph-legend-item">
                                    <span class="graph-legend-line graph-legend-line--conditional"></span> Conditional
                                </div>
                                <div class="graph-legend-item">
                                    <span class="graph-legend-dot graph-legend-dot--prompt"></span> Has Prompt
                                </div>
                                <div class="graph-legend-item">
                                    <span class="graph-legend-swatch graph-legend-swatch--easy"></span> Easy
                                </div>
                                <div class="graph-legend-item">
                                    <span class="graph-legend-swatch graph-legend-swatch--medium"></span> Medium
                                </div>
                                <div class="graph-legend-item">
                                    <span class="graph-legend-swatch graph-legend-swatch--hard"></span> Hard
                                </div>
                                <div class="graph-legend-item">
                                    <span class="graph-legend-swatch graph-legend-swatch--resilience"></span> Resilience
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Info Tab -->
                    <div class="tab-pane" id="info-tab">
                        <div class="info-panel">
                            <div id="info-session-detail">
                                <div class="empty-state">
                                    <p>Select a session to view its details</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="tab-pane" id="settings-tab">
                        <div class="settings-panel">
                            <div class="settings-header">
                                <h3>Settings</h3>
                                <div class="settings-actions">
                                    <button class="btn btn-sm" onclick="exportConfigs()">Export</button>
                                    <button class="btn btn-sm" onclick="showImportConfigModal()">Import</button>
                                    <button class="btn btn-sm" onclick="loadConfigs()">Refresh</button>
                                </div>
                            </div>
                            <div class="settings-content">
                                <div class="settings-sidebar">
                                    <div class="settings-categories" id="settings-categories">
                                        <!-- Categories will be loaded dynamically -->
                                    </div>
                                </div>
                                <div class="settings-main">
                                    <div class="config-list" id="config-list">
                                        <div class="loading">Loading configurations...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Create Session Modal -->
        <div class="modal-overlay hidden" id="create-session-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3>Create New Session</h3>
                    <button class="btn-close" onclick="hideCreateSessionModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="new-session-name">Session Name</label>
                        <input type="text" id="new-session-name" placeholder="my-session">
                    </div>
                    <div class="form-group">
                        <label for="new-session-role">Role</label>
                        <select id="new-session-role" onchange="onRoleSelect()">
                            <option value="worker">Worker</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                    <div class="form-group" id="manager-select-group">
                        <label for="new-session-manager">Manager Session</label>
                        <select id="new-session-manager">
                            <option value="">None (Standalone)</option>
                            {% for session in initial_sessions if session.role == 'manager' %}
                            <option value="{{ session.session_id }}">{{ session.session_name or session.session_id[:8] }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-hint">Select a manager to control this worker</small>
                    </div>
                    <div class="form-group">
                        <label for="new-session-prompt">System Prompt</label>
                        <select id="new-session-prompt" onchange="onPromptSelect()">
                            <option value="">None</option>
                            {% for prompt in initial_prompts %}
                            <option value="{{ prompt.name }}" {{ 'selected' if prompt.name == 'self-manager' else '' }}>{{ prompt.description or prompt.name }}</option>
                            {% endfor %}
                            <option value="custom">Custom...</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="custom-prompt-group">
                        <label for="new-session-custom-prompt">Custom Prompt</label>
                        <textarea id="new-session-custom-prompt" rows="6" placeholder="Enter your custom system prompt here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="new-session-model">Model</label>
                        <select id="new-session-model">
                            <option value="">Default</option>
                            <option value="claude-opus-4-20250514">Claude Opus 4</option>
                            <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                            <option value="claude-opus-4-0603">Claude Opus 4.5</option>
                            <option value="claude-opus-4-20260115">Claude Opus 4.6</option>
                            <option value="claude-sonnet-4-20260115">Claude Sonnet 4.5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-session-max-turns">Max Turns</label>
                        <input type="number" id="new-session-max-turns" value="100" min="1" max="500">
                    </div>
                    <div class="form-group">
                        <label for="new-session-timeout">Timeout (seconds)</label>
                        <input type="number" id="new-session-timeout" value="1800" min="60" max="7200">
                    </div>
                    <div class="form-group">
                        <label for="new-session-max-iterations">Max Iterations (Autonomous)</label>
                        <input type="number" id="new-session-max-iterations" value="100" min="1" max="500">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="new-session-autonomous" checked>
                            Autonomous Mode
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="hideCreateSessionModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="createSession()">Create</button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal-overlay hidden" id="delete-session-modal">
            <div class="modal modal-sm">
                <div class="modal-header">
                    <h3>Delete Session</h3>
                    <button class="btn-close" onclick="hideDeleteSessionModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete session <strong id="delete-session-name"></strong>?</p>
                    <p class="text-muted">The session will be stopped but its metadata is preserved. You can restore it later from the Info tab.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="hideDeleteSessionModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDeleteSession()">Delete</button>
                </div>
            </div>
        </div>

        <!-- Config Edit Modal -->
        <div class="modal-overlay hidden" id="config-edit-modal">
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3 id="config-edit-title">Edit Configuration</h3>
                    <button class="btn-close" onclick="hideConfigEditModal()">√ó</button>
                </div>
                <div class="modal-body" id="config-edit-body">
                    <!-- Config form will be rendered dynamically -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="resetConfigToDefaults()">Reset to Defaults</button>
                    <button class="btn btn-secondary" onclick="hideConfigEditModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig()">Save</button>
                </div>
            </div>
        </div>

        <!-- Config Import Modal -->
        <div class="modal-overlay hidden" id="config-import-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3>Import Configurations</h3>
                    <button class="btn-close" onclick="hideImportConfigModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="config-import-data">Paste exported config JSON:</label>
                        <textarea id="config-import-data" rows="10" placeholder='{"discord": {...}, "slack": {...}}'></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="hideImportConfigModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="importConfigs()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Playground View Modules (Three.js 3D based) -->
    <script src="/static/playground/pathfinding.js"></script>
    <script src="/static/playground/playground-3d-layout.js"></script>
    <script src="/static/playground/playground-3d-assets.js?v=2"></script>
    <script src="/static/playground/playground-avatar-system.js?v=2"></script>
    <script src="/static/playground/playground-3d-scene.js?v=2"></script>

    <!-- Application Components -->
    <script src="/static/components/state.js"></script>
    <script src="/static/components/api.js"></script>
    <script src="/static/components/utils.js"></script>
    <script src="/static/components/prompts.js"></script>
    <script src="/static/components/sessions.js?v=2"></script>
    <script src="/static/components/command.js"></script>
    <script src="/static/components/logs.js"></script>
    <script src="/static/components/batch.js"></script>
    <script src="/static/components/storage.js?v=2"></script>
    <script src="/static/components/dashboard.js?v=2"></script>
    <script src="/static/components/config.js"></script>
    <script src="/static/components/graph.js?v=2"></script>
    <script src="/static/components/info.js?v=2"></script>
    <script src="/static/components/playground-ui.js"></script>
    <script src="/static/components/modals.js"></script>
    <script src="/static/app.js?v=2"></script>
</body>
</html>
