<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Claude Control</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/playground/playground.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Three.js (for 3D rendering) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/RGBELoader.js"></script>
    <script>
        // SkeletonUtils polyfill for r128
        THREE.SkeletonUtils = {
            clone: function(source) {
                const sourceLookup = new Map();
                const cloneLookup = new Map();
                const clone = source.clone();

                parallelTraverse(source, clone, function(sourceNode, clonedNode) {
                    sourceLookup.set(clonedNode, sourceNode);
                    cloneLookup.set(sourceNode, clonedNode);
                });

                clone.traverse(function(node) {
                    if (!node.isSkinnedMesh) return;
                    const clonedMesh = node;
                    const sourceMesh = sourceLookup.get(node);
                    const sourceBones = sourceMesh.skeleton.bones;

                    clonedMesh.skeleton = sourceMesh.skeleton.clone();
                    clonedMesh.bindMatrix.copy(sourceMesh.bindMatrix);

                    clonedMesh.skeleton.bones = sourceBones.map(function(bone) {
                        return cloneLookup.get(bone);
                    });

                    clonedMesh.bind(clonedMesh.skeleton, clonedMesh.bindMatrix);
                });

                return clone;

                function parallelTraverse(a, b, callback) {
                    callback(a, b);
                    for (let i = 0; i < a.children.length; i++) {
                        parallelTraverse(a.children[i], b.children[i], callback);
                    }
                }
            }
        };
        console.log('[Three.js] SkeletonUtils polyfill loaded');
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="logo">Claude Control</h1>
            </div>
            <div class="header-right">
                <div class="health-indicator" id="health-indicator">
                    <span class="health-dot"></span>
                    <span class="health-text">Connecting...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar - Session List -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2>Sessions</h2>
                    <div class="sidebar-header-actions">
                        <button class="btn btn-primary btn-sm" onclick="showCreateSessionModal()">New Session</button>
                        <button class="btn btn-sm sidebar-toggle-btn" onclick="toggleSidebar()" aria-label="Toggle sidebar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="18 15 12 9 6 15"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="session-stats" id="session-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="stat-total">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item running">
                        <span class="stat-value" id="stat-running">0</span>
                        <span class="stat-label">Running</span>
                    </div>
                    <div class="stat-item error">
                        <span class="stat-value" id="stat-error">0</span>
                        <span class="stat-label">Error</span>
                    </div>
                </div>
                <div class="session-list" id="session-list">
                    <div class="loading">Loading sessions...</div>
                </div>
            </aside>

            <!-- Main Panel -->
            <section class="main-panel">
                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn" data-tab="playground" onclick="switchTab('playground')">Playground</button>
                    <button class="tab-btn active" data-tab="command" onclick="switchTab('command')">Command</button>
                    <button class="tab-btn" data-tab="logs" onclick="switchTab('logs')">Logs</button>
                    <button class="tab-btn" data-tab="storage" onclick="switchTab('storage')">Storage</button>
                    <button class="tab-btn" data-tab="batch" onclick="switchTab('batch')">Batch</button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Playground Tab -->
                    <div class="tab-pane" id="playground-tab">
                        <div class="playground-panel" id="playground-panel">
                            <div class="playground-toolbar">
                                <div class="playground-toolbar-left">
                                    <div class="playground-title">
                                        <span class="playground-title-icon">üèôÔ∏è</span>
                                        City Playground
                                    </div>
                                    <span class="playground-session-count" id="playground-session-count">0 citizens</span>
                                </div>
                                <div class="playground-toolbar-right">
                                    <button class="playground-btn" onclick="playgroundZoomIn()" title="Zoom In">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    </button>
                                    <button class="playground-btn" onclick="playgroundZoomOut()" title="Zoom Out">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    </button>
                                    <button class="playground-btn" onclick="playgroundResetView()" title="Reset View">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="playground-canvas-container" id="playground-canvas">
                                <div class="playground-loading" id="playground-loading">
                                    <div class="playground-loading-spinner"></div>
                                    <div class="playground-loading-text">Building city...</div>
                                </div>
                            </div>
                            <div class="playground-status-overlay" id="playground-status-overlay"></div>
                            <div class="playground-empty-state" id="playground-empty-state" style="display:none">
                                <div class="playground-empty-text">Create sessions to see citizens in the city!</div>
                            </div>
                        </div>
                    </div>

                    <!-- Command Tab -->
                    <div class="tab-pane active" id="command-tab">
                        <div class="no-session-selected" id="no-session-message">
                            <div class="empty-state">
                                <h3>Select a Session</h3>
                                <p>Choose a session from the list to execute commands</p>
                            </div>
                        </div>
                        <div class="command-panel hidden" id="command-panel">
                            <div class="selected-session-info" id="selected-session-info">
                                <!-- Session info will be displayed here -->
                            </div>
                            <div class="command-input-area">
                                <textarea
                                    id="command-input"
                                    placeholder="Enter your prompt here..."
                                    rows="4"
                                ></textarea>
                                <div class="command-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="skip-permissions" checked>
                                        Skip Permissions
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="auto-continue">
                                        Auto Continue
                                    </label>
                                    <label class="input-label">
                                        Timeout (s):
                                        <input type="number" id="command-timeout" value="1800" min="1" max="7200">
                                    </label>
                                    <label class="input-label">
                                        Max Turns:
                                        <input type="number" id="command-max-turns" value="100" min="1" max="500">
                                    </label>
                                </div>
                                <div class="command-actions">
                                    <button class="btn btn-primary" id="execute-btn" onclick="executeCommand()">Execute</button>
                                    <button class="btn btn-danger hidden" id="stop-btn" onclick="stopAutoContinue()">Stop</button>
                                    <button class="btn btn-secondary" onclick="clearOutput()">Clear</button>
                                </div>
                            </div>
                            <div class="command-output-area">
                                <div class="output-header">
                                    <h3>Output</h3>
                                    <span class="execution-status" id="execution-status"></span>
                                </div>
                                <pre class="output-content" id="command-output">No output yet</pre>
                            </div>
                        </div>
                    </div>

                    <!-- Logs Tab -->
                    <div class="tab-pane" id="logs-tab">
                        <div class="no-session-selected" id="no-session-logs-message">
                            <div class="empty-state">
                                <h3>Select a Session</h3>
                                <p>Choose a session from the list to view logs</p>
                            </div>
                        </div>
                        <div class="logs-panel hidden" id="logs-panel">
                            <div class="logs-header">
                                <h3 id="logs-session-title">Session Logs</h3>
                                <div class="logs-controls">
                                    <select id="log-level-filter" onchange="loadSessionLogs()">
                                        <option value="">All Levels</option>
                                        <option value="DEBUG">DEBUG</option>
                                        <option value="INFO">INFO</option>
                                        <option value="WARNING">WARNING</option>
                                        <option value="ERROR">ERROR</option>
                                        <option value="COMMAND">COMMAND</option>
                                        <option value="RESPONSE">RESPONSE</option>
                                    </select>
                                    <button class="btn btn-sm" onclick="loadSessionLogs()">Refresh</button>
                                </div>
                            </div>
                            <div class="logs-content" id="logs-content">
                                <div class="loading">Loading logs...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Tab -->
                    <div class="tab-pane" id="batch-tab">
                        <div class="batch-panel">
                            <div class="batch-header">
                                <h3>Batch Command Execution</h3>
                            </div>
                            <div class="batch-sessions">
                                <label>Select Sessions:</label>
                                <div class="batch-session-list" id="batch-session-list">
                                    <!-- Session checkboxes will be rendered here -->
                                </div>
                                <div class="batch-select-actions">
                                    <button class="btn btn-sm" onclick="selectAllSessions()">Select All</button>
                                    <button class="btn btn-sm" onclick="deselectAllSessions()">Deselect All</button>
                                </div>
                            </div>
                            <div class="batch-input">
                                <textarea
                                    id="batch-command-input"
                                    placeholder="Enter command to execute on all selected sessions..."
                                    rows="4"
                                ></textarea>
                                <div class="batch-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="batch-parallel" checked>
                                        Execute in Parallel
                                    </label>
                                    <label class="input-label">
                                        Timeout (s):
                                        <input type="number" id="batch-timeout" value="1800" min="1" max="7200">
                                    </label>
                                </div>
                                <button class="btn btn-primary" onclick="executeBatchCommand()">Execute Batch</button>
                            </div>
                            <div class="batch-results" id="batch-results">
                                <!-- Batch results will be displayed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Storage Tab -->
                    <div class="tab-pane" id="storage-tab">
                        <div class="storage-panel">
                            <div class="storage-header">
                                <h3>Session Storage</h3>
                                <div class="storage-actions">
                                    <button class="btn btn-sm" onclick="refreshStorage()">Refresh</button>
                                </div>
                            </div>
                            <div class="storage-content">
                                <div class="storage-tree" id="storage-tree">
                                    <p class="storage-placeholder">Select a session to view its storage</p>
                                </div>
                                <div class="storage-preview" id="storage-preview">
                                    <div class="preview-header">
                                        <span id="preview-filename">No file selected</span>
                                    </div>
                                    <pre class="preview-content" id="preview-content"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Create Session Modal -->
        <div class="modal-overlay hidden" id="create-session-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3>Create New Session</h3>
                    <button class="btn-close" onclick="hideCreateSessionModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="new-session-name">Session Name</label>
                        <input type="text" id="new-session-name" placeholder="my-session">
                    </div>
                    <div class="form-group">
                        <label for="new-session-prompt">System Prompt</label>
                        <select id="new-session-prompt" onchange="onPromptSelect()">
                            <option value="">None</option>
                            <!-- Prompts will be loaded dynamically -->
                            <option value="custom">Custom...</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="custom-prompt-group">
                        <label for="new-session-custom-prompt">Custom Prompt</label>
                        <textarea id="new-session-custom-prompt" rows="6" placeholder="Enter your custom system prompt here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="new-session-model">Model</label>
                        <select id="new-session-model">
                            <option value="">Default</option>
                            <option value="claude-opus-4-20250514">Claude Opus 4</option>
                            <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                            <option value="claude-opus-4-0603">Claude Opus 4.5</option>
                            <option value="claude-opus-4-20260115">Claude Opus 4.6</option>
                            <option value="claude-sonnet-4-20260115">Claude Sonnet 4.5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-session-max-turns">Max Turns</label>
                        <input type="number" id="new-session-max-turns" value="100" min="1" max="500">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="new-session-autonomous" checked>
                            Autonomous Mode
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="hideCreateSessionModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="createSession()">Create</button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal-overlay hidden" id="delete-session-modal">
            <div class="modal modal-sm">
                <div class="modal-header">
                    <h3>Delete Session</h3>
                    <button class="btn-close" onclick="hideDeleteSessionModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete session <strong id="delete-session-name"></strong>?</p>
                    <p class="text-muted">This will terminate the session and delete all associated data.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="hideDeleteSessionModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDeleteSession()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Playground View Modules (Three.js 3D based) -->
    <script src="/static/playground/pathfinding.js"></script>
    <script src="/static/playground/playground-3d-layout.js"></script>
    <script src="/static/playground/playground-3d-assets.js"></script>
    <script src="/static/playground/playground-avatar-system.js"></script>
    <script src="/static/playground/playground-3d-scene.js"></script>

    <script src="/static/app.js"></script>
</body>
</html>
